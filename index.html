<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Pastel Splash Dash - Fixed</title>
<style>
  html, body { margin: 0; padding: 0; background: #fdf6fb; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
  canvas { display: block; margin: auto; background: #fff5f8; cursor: crosshair; }
  #ui { position: fixed; top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #d63384; z-index: 10; pointer-events: none; }
  #gameover { 
    position: fixed; inset: 0; background: rgba(255,240,250,0.95); 
    display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; z-index: 20;
  }
  h2 { color: #ff4d94; font-size: 32px; margin: 0 0 10px 0; }
  button { 
    padding: 15px 40px; border: none; background: #ffb7d5; color: white; 
    border-radius: 30px; font-size: 20px; cursor: pointer; transition: 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  button:active { transform: scale(0.95); }
</style>
</head>
<body>

<div id="ui">üå∏ ƒêi·ªÉm: <span id="score">0</span></div>

<div id="gameover">
  <h2>üì∏ B·ªä PH√ÅT HI·ªÜN R·ªíI!</h2>
  <p id="final-score" style="margin-bottom: 20px; font-weight: bold; color: #555;"></p>
  <button id="restartBtn">Ch∆°i l·∫°i</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");
const gameoverEl = document.getElementById("gameover");
const restartBtn = document.getElementById("restartBtn");

// T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc canvas theo m√†n h√¨nh nh∆∞ng gi·ªØ t·ª∑ l·ªá
function resize() {
    const ratio = 360 / 640;
    canvas.height = window.innerHeight;
    canvas.width = canvas.height * ratio;
    if (canvas.width > window.innerWidth) {
        canvas.width = window.innerWidth;
        canvas.height = canvas.width / ratio;
    }
}
window.addEventListener('resize', resize);
resize();

let score = 0;
let over = false;
let targetX = canvas.width / 2;
const splashes = [];

/* ===== H·ªÜ TH·ªêNG √ÇM THANH ===== */
let audioCtx;
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playSound(freq, type, duration) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

/* ===== ƒê·ªêI T∆Ø·ª¢NG ===== */
const girl = { x: 0, y: 0, w: 40, h: 60 };
const man = { x: -60, y: 0, w: 40, h: 60, speed: 2 };
const cam = { x: 0, y: 30, w: 60, h: 30, dir: 1 };

function resetEntities() {
    girl.y = canvas.height - 100;
    girl.x = canvas.width / 2 - 20;
    targetX = canvas.width / 2;
    man.y = canvas.height - 110;
    man.x = -100;
    man.speed = 2 + (score * 0.1);
    cam.x = 0; // ƒê·ªÉ camera xu·∫•t hi·ªán b√™n tr√°i, tr√°nh k·∫πt ngay gi·ªØa
}

/* ===== HI·ªÜU ·ª®NG T·∫†T N∆Ø·ªöC ===== */
function createSplash(x, y) {
    for (let i = 0; i < 20; i++) {
        splashes.push({
            x: x, y: y,
            radius: Math.random() * 6 + 2,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.8) * 10,
            alpha: 1,
            color: `hsl(${190 + Math.random() * 20}, 100%, 75%)`
        });
    }
}

/* ===== V·∫º ===== */
function drawGirl() {
    ctx.fillStyle = "#ffb6d9"; // V√°y
    ctx.beginPath();
    ctx.moveTo(girl.x, girl.y + 60);
    ctx.lineTo(girl.x + 40, girl.y + 60);
    ctx.lineTo(girl.x + 30, girl.y + 20);
    ctx.lineTo(girl.x + 10, girl.y + 20);
    ctx.fill();
    ctx.fillStyle = "#ffe0bd"; // M·∫∑t
    ctx.fillRect(girl.x + 10, girl.y, 20, 20);
    ctx.fillStyle = "#654321"; // T√≥c
    ctx.fillRect(girl.x + 8, girl.y - 5, 24, 12);
}

function drawMan() {
    ctx.fillStyle = "#4a90e2";
    ctx.fillRect(man.x + 5, man.y + 20, 30, 40);
    ctx.fillStyle = "#ffe0bd";
    ctx.fillRect(man.x + 10, man.y, 20, 20);
}

function drawCamera() {
    // Lu·ªìng s√°ng nguy hi·ªÉm
    const grad = ctx.createLinearGradient(0, cam.y, 0, canvas.height);
    grad.addColorStop(0, "rgba(255, 255, 0, 0.4)");
    grad.addColorStop(1, "rgba(255, 255, 0, 0)");
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(cam.x, cam.y + cam.h);
    ctx.lineTo(cam.x + cam.w, cam.y + cam.h);
    ctx.lineTo(cam.x + cam.w + 50, canvas.height);
    ctx.lineTo(cam.x - 50, canvas.height);
    ctx.fill();

    // Th√¢n camera
    ctx.fillStyle = "#333";
    ctx.fillRect(cam.x, cam.y, cam.w, cam.h);
    ctx.fillStyle = "red"; // ƒê√®n b√°o
    if (Math.floor(Date.now() / 400) % 2) ctx.beginPath(), ctx.arc(cam.x + 10, cam.y + 10, 3, 0, 7), ctx.fill();
}

/* ===== V√íNG L·∫∂P CH√çNH ===== */
function update() {
    if (over) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Di chuy·ªÉn
    girl.x += (targetX - girl.x - girl.w/2) * 0.1;
    man.x += man.speed;
    if (man.x > canvas.width + 50) man.x = -100;

    cam.x += cam.dir * (1.5 + score * 0.05);
    if (cam.x > canvas.width - cam.w || cam.x < 0) cam.dir *= -1;

    // Check va ch·∫°m Camera (Lu·ªìng s√°ng)
    const lightLeft = cam.x - 30;
    const lightRight = cam.x + cam.w + 30;
    if (girl.x + girl.w > lightLeft && girl.x < lightRight) {
        over = true;
        gameoverEl.style.display = "flex";
        document.getElementById("final-score").textContent = "Ghi ƒë∆∞·ª£c: " + score + " ƒëi·ªÉm";
        playSound(100, 'sawtooth', 0.4);
    }

    // X·ª≠ l√Ω tia n∆∞·ªõc
    for (let i = splashes.length - 1; i >= 0; i--) {
        const s = splashes[i];
        s.x += s.vx; s.y += s.vy; s.alpha -= 0.02;
        if (s.alpha <= 0) splashes.splice(i, 1);
        else {
            ctx.globalAlpha = s.alpha;
            ctx.fillStyle = s.color;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.radius, 0, 7); ctx.fill();
        }
    }
    ctx.globalAlpha = 1;

    drawCamera();
    drawMan();
    drawGirl();

    requestAnimationFrame(update);
}

/* ===== S·ª∞ KI·ªÜN ===== */
const inputHandler = (e) => {
    initAudio(); // K√≠ch ho·∫°t audio khi ch·∫°m l·∫ßn ƒë·∫ßu
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    targetX = x;
};

canvas.addEventListener("mousedown", (e) => {
    inputHandler(e);
    if (Math.abs(girl.x - man.x) < 60) {
        score++;
        scoreEl.textContent = score;
        createSplash(man.x + 20, man.y + 20);
        man.x = -100;
        playSound(500, 'sine', 0.1);
    }
});
canvas.addEventListener("mousemove", inputHandler);
canvas.addEventListener("touchstart", (e) => { e.preventDefault(); inputHandler(e); }, {passive: false});
canvas.addEventListener("touchmove", (e) => { e.preventDefault(); inputHandler(e); }, {passive: false});

function restart() {
    score = 0;
    scoreEl.textContent = "0";
    over = false;
    gameoverEl.style.display = "none";
    splashes.length = 0;
    resetEntities();
    update();
}

restartBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    restart();
});

// Kh·ªüi t·∫°o v·ªã tr√≠ ban ƒë·∫ßu
resetEntities();
update();
</script>
</body>
</html>
