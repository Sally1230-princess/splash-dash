<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Pastel Anime Dash</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0f172a;
  overflow: hidden;
}
canvas {
  display: block;
  margin: auto;
  image-rendering: pixelated;
  touch-action: manipulation;
}
#hint {
  position: fixed;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 12px;
  color: #fff;
  opacity: 0.7;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="hint">Tap trái / phải để chạy & nhảy</div>

<script>
/* =========================
   CORE CONFIG
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const SCALE = 4;
const W = 96;
const H = 160;

canvas.width = W * SCALE;
canvas.height = H * SCALE;
ctx.scale(SCALE, SCALE);

/* =========================
   AUDIO (simple synth)
========================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur=0.08) {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g);
  g.connect(audioCtx.destination);
  o.frequency.value = freq;
  o.type = "square";
  g.gain.value = 0.05;
  o.start();
  setTimeout(() => o.stop(), dur * 1000);
}

/* =========================
   GAME STATE
========================= */
let player = {
  x: 44,
  y: 120,
  vy: 0,
  frame: 0,
  onGround: true
};

let enemies = [];
let boss = null;

let score = 0;
let hiScore = Number(localStorage.getItem("hiScore") || 0);
let night = false;
let tick = 0;

/* =========================
   SPAWN
========================= */
function spawnEnemy() {
  enemies.push({
    x: Math.random() > 0.5 ? -10 : 100,
    y: 120,
    dir: Math.random() > 0.5 ? 1 : -1
  });
}

function spawnBoss() {
  boss = {
    x: 30,
    y: 90,
    hp: 30,
    dir: 1
  };
}

/* =========================
   BACKGROUND
========================= */
function drawBG() {
  ctx.fillStyle = night ? "#1e293b" : "#fdeaf5";
  ctx.fillRect(0, 0, W, H);

  ctx.fillStyle = night ? "rgba(255,255,255,0.2)" : "rgba(255,255,255,0.7)";
  for (let y = 0; y < H; y += 16) {
    for (let x = 0; x < W; x += 16) {
      ctx.beginPath();
      ctx.arc((x + tick) % W, (y + tick) % H, 1.5, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  ctx.fillStyle = night ? "#020617" : "#ffd6e8";
  ctx.fillRect(0, 140, W, 20);
}

/* =========================
   PLAYER SPRITE
========================= */
function drawPlayer(x, y) {
  const f = Math.floor(player.frame) % 2;

  // hair
  ctx.fillStyle = "#5a2e1b";
  ctx.fillRect(x+2, y, 10, 4);

  // face
  ctx.fillStyle = "#ffd7b3";
  ctx.fillRect(x+3, y+4, 8, 6);

  // eyes
  ctx.fillStyle = "#000";
  ctx.fillRect(x+5, y+7, 1, 1);
  ctx.fillRect(x+8, y+7, 1, 1);

  // dress
  ctx.fillStyle = "#ffb6d9";
  ctx.fillRect(x+2, y+10, 10, 8);

  // legs (animation)
  ctx.fillStyle = "#000";
  ctx.fillRect(x+4 + f, y+18, 2, 4);
  ctx.fillRect(x+8 - f, y+18, 2, 4);
}

/* =========================
   ENEMY
========================= */
function drawEnemy(e) {
  ctx.fillStyle = "#0f172a";
  ctx.fillRect(e.x+2, e.y, 10, 6);

  ctx.fillStyle = "#ffd7b3";
  ctx.fillRect(e.x+3, e.y+6, 8, 6);

  ctx.fillStyle = "#334155";
  ctx.fillRect(e.x+2, e.y+12, 10, 8);
}

/* =========================
   BOSS
========================= */
function drawBoss(b) {
  ctx.fillStyle = "#7c2d12";
  ctx.fillRect(b.x, b.y, 20, 20);

  ctx.fillStyle = "#fde68a";
  ctx.fillRect(b.x+4, b.y+6, 4, 4);
  ctx.fillRect(b.x+12, b.y+6, 4, 4);

  ctx.fillStyle = "#ef4444";
  ctx.fillRect(b.x, b.y-4, (b.hp/30)*20, 2);
}

/* =========================
   INPUT
========================= */
canvas.addEventListener("touchstart", e => {
  audioCtx.resume();
  const x = e.touches[0].clientX;

  if (x < window.innerWidth / 2) player.x -= 6;
  else player.x += 6;

  if (player.onGround) {
    player.vy = -6;
    player.onGround = false;
    beep(600);
  }
});

/* =========================
   UPDATE
========================= */
function update() {
  tick++;

  // gravity
  player.vy += 0.3;
  player.y += player.vy;

  if (player.y >= 120) {
    player.y = 120;
    player.vy = 0;
    player.onGround = true;
  }

  player.frame += 0.2;

  // enemies
  enemies.forEach(e => {
    e.x += e.dir * 0.5;
  });

  enemies = enemies.filter(e => e.x > -20 && e.x < 120);

  // collision enemy
  enemies.forEach(e => {
    if (Math.abs(player.x - e.x) < 10 && Math.abs(player.y - e.y) < 10) {
      score = Math.max(0, score - 5);
      beep(200);
    }
  });

  // boss logic
  if (boss) {
    boss.x += boss.dir * 0.6;
    if (boss.x < 10 || boss.x > 60) boss.dir *= -1;

    if (Math.abs(player.x - boss.x) < 14 && Math.abs(player.y - boss.y) < 14) {
      boss.hp--;
      beep(120);
      if (boss.hp <= 0) {
        boss = null;
        score += 100;
        beep(900, 0.2);
      }
    }
  }

  // spawn
  if (tick % 120 === 0) spawnEnemy();
  if (score > 200 && !boss) spawnBoss();

  // day / night
  if (tick % 600 === 0) night = !night;

  score++;
  hiScore = Math.max(hiScore, score);
  localStorage.setItem("hiScore", hiScore);
}

/* =========================
   UI
========================= */
function drawUI() {
  ctx.fillStyle = "#6b4c6b";
  ctx.font = "6px monospace";
  ctx.fillText("SCORE " + score, 4, 8);
  ctx.fillText("BEST " + hiScore, 60, 8);

  if (boss) ctx.fillText("BOSS!", 42, 20);
}

/* =========================
   LOOP
========================= */
function loop() {
  drawBG();
  update();
  enemies.forEach(drawEnemy);
  if (boss) drawBoss(boss);
  drawPlayer(player.x, player.y);
  drawUI();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
