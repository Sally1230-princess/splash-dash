<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Pastel Splash Dash Pro</title>

<style>
  html, body { margin: 0; padding: 0; background: #fdf6fb; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
  canvas { display: block; margin: auto; background: #fff5f8; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
  #ui { position: fixed; top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #d63384; text-shadow: 1px 1px white; }
  #gameover { 
    position: fixed; inset: 0; background: rgba(255,240,250,0.95); 
    display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center;
  }
  h2 { color: #ff4d94; font-size: 32px; margin-bottom: 10px; }
  button { 
    padding: 15px 40px; border: none; background: #ffb7d5; color: white; 
    border-radius: 30px; font-size: 20px; cursor: pointer; transition: 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  button:hover { background: #ff85b9; transform: scale(1.05); }
</style>
</head>

<body>

<div id="ui">üå∏ ƒêi·ªÉm: <span id="score">0</span></div>

<div id="gameover">
  <h2>üì∏ B·ªä PH√ÅT HI·ªÜN R·ªíI!</h2>
  <p id="final-score" style="margin-bottom: 20px;"></p>
  <button onclick="restart()">Ch∆°i l·∫°i</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");
const gameoverEl = document.getElementById("gameover");

// C·∫•u h√¨nh m√†n h√¨nh
canvas.width = 360;
canvas.height = 640;

let score = 0;
let over = false;
let targetX = 180;

/* ===== √ÇM THANH (D√πng Web Audio API) ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

/* ===== ƒê·ªêI T∆Ø·ª¢NG ===== */
const girl = { x: 180, y: 520, w: 40, h: 60 };
const man = { x: -60, y: 530, w: 40, h: 60, speed: 2.5 };
const cam = { x: 140, y: 50, w: 80, h: 40, range: 100, dir: 1 };

// M·∫£ng ƒë·ªÉ l∆∞u tr·ªØ c√°c tia n∆∞·ªõc
const splashes = [];

/* ===== V·∫º CHI TI·∫æT ===== */
function drawGirl(x, y) {
    // V√°y
    ctx.fillStyle = "#ffb6d9";
    ctx.beginPath();
    ctx.moveTo(x, y + 60);
    ctx.lineTo(x + 40, y + 60);
    ctx.lineTo(x + 30, y + 20);
    ctx.lineTo(x + 10, y + 20);
    ctx.fill();
    // ƒê·∫ßu
    ctx.fillStyle = "#ffe0bd";
    ctx.fillRect(x + 10, y, 20, 20);
    // T√≥c
    ctx.fillStyle = "#654321";
    ctx.fillRect(x + 8, y - 5, 24, 15);
    // M·∫Øt
    ctx.fillStyle = "#000";
    ctx.fillRect(x + 14, y + 5, 3, 3);
    ctx.fillRect(x + 23, y + 5, 3, 3);
}

function drawMan(x, y) {
    // Qu·∫ßn √°o
    ctx.fillStyle = "#4a90e2";
    ctx.fillRect(x + 5, y + 20, 30, 40);
    // ƒê·∫ßu
    ctx.fillStyle = "#ffe0bd";
    ctx.fillRect(x + 10, y, 20, 20);
    // T√≥c
    ctx.fillStyle = "#333";
    ctx.fillRect(x + 10, y - 2, 20, 7);
}

function drawCamera() {
    // Th√¢n m√°y
    ctx.fillStyle = "#555";
    ctx.fillRect(cam.x, cam.y, cam.w, cam.h);
    ctx.fillStyle = "#333";
    ctx.fillRect(cam.x + 20, cam.y + 10, 40, 20);
    
    // ƒê√®n ƒë·ªè nh√°y
    if (Math.floor(Date.now() / 500) % 2) {
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(cam.x + 10, cam.y + 10, 4, 0, Math.PI * 2);
        ctx.fill();
    }

    // V√πng qu√©t (Tia s√°ng)
    const gradient = ctx.createLinearGradient(0, cam.y, 0, canvas.height);
    gradient.addColorStop(0, "rgba(255, 255, 0, 0.3)");
    gradient.addColorStop(1, "rgba(255, 255, 0, 0)");
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(cam.x, cam.y + cam.h);
    ctx.lineTo(cam.x + cam.w, cam.y + cam.h);
    ctx.lineTo(cam.x + cam.w + 40, canvas.height);
    ctx.lineTo(cam.x - 40, canvas.height);
    ctx.fill();
}

// H√†m t·∫°o tia n∆∞·ªõc
function createSplash(x, y) {
    for (let i = 0; i < 15; i++) { // T·∫°o 15 tia n∆∞·ªõc nh·ªè
        splashes.push({
            x: x + Math.random() * 20 - 10,
            y: y + Math.random() * 20 - 10,
            radius: Math.random() * 5 + 2,
            vx: (Math.random() - 0.5) * 5,
            vy: (Math.random() - 0.5) * 5 - 2, // H∆°i bay l√™n
            alpha: 1,
            color: `hsl(${Math.random() * 30 + 190}, 100%, 70%)` // M√†u xanh nh·∫°t
        });
    }
}

// H√†m v·∫Ω tia n∆∞·ªõc
function drawSplash(splash) {
    ctx.globalAlpha = splash.alpha;
    ctx.fillStyle = splash.color;
    ctx.beginPath();
    ctx.arc(splash.x, splash.y, splash.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1; // Reset alpha
}


/* ===== LOGIC ===== */
function rectHit(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

function handleInput(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    targetX = clientX - rect.left;
}

canvas.addEventListener("mousemove", handleInput);
canvas.addEventListener("touchmove", handleInput);
canvas.addEventListener("mousedown", () => {
    if (over) return;
    // Ki·ªÉm tra va ch·∫°m v·ªõi Man ƒë·ªÉ ghi ƒëi·ªÉm
    if (Math.abs(girl.x - man.x) < 40) { // Kho·∫£ng c√°ch ƒë·ªß g·∫ßn ƒë·ªÉ t·∫°t
        score++;
        scoreEl.textContent = score;
        createSplash(man.x + man.w / 2, man.y + man.h / 2); // T·∫°o hi·ªáu ·ª©ng t·∫°t n∆∞·ªõc t·∫°i Man
        man.x = -60;
        man.speed += 0.2; // Kh√≥ d·∫ßn
        playSound(600, 'sine', 0.1);
    }
});

function update() {
    if (over) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Di chuy·ªÉn Girl
    girl.x += (targetX - girl.x - girl.w/2) * 0.15;
    girl.x = Math.max(0, Math.min(canvas.width - girl.w, girl.x));

    // Di chuy·ªÉn Man
    man.x += man.speed;
    if (man.x > canvas.width + 60) man.x = -60;

    // Di chuy·ªÉn Camera qu√©t qua l·∫°i
    cam.x += cam.dir * 1.5;
    if (cam.x > canvas.width - cam.w || cam.x < 0) cam.dir *= -1;

    // C·∫≠p nh·∫≠t v√† v·∫Ω c√°c tia n∆∞·ªõc
    for (let i = splashes.length - 1; i >= 0; i--) {
        const splash = splashes[i];
        splash.x += splash.vx;
        splash.y += splash.vy;
        splash.alpha -= 0.03; // L√†m m·ªù d·∫ßn
        splash.radius *= 0.98; // Nh·ªè d·∫ßn
        if (splash.alpha <= 0.05 || splash.radius < 1) {
            splashes.splice(i, 1); // X√≥a tia n∆∞·ªõc khi bi·∫øn m·∫•t
        }
        drawSplash(splash);
    }


    // Ki·ªÉm tra Camera b·∫Øt
    // N·∫øu ch√¢n c·ªßa Girl n·∫±m trong kho·∫£ng X c·ªßa lu·ªìng s√°ng camera
    const camLeftAtGirl = cam.x - 30; // V√πng qu√©t r·ªông h∆°n camera v·∫≠t l√Ω
    const camRightAtGirl = cam.x + cam.w + 30;
    if (girl.x + girl.w > camLeftAtGirl && girl.x < camRightAtGirl) {
        over = true;
        document.getElementById("final-score").textContent = "B·∫°n ghi ƒë∆∞·ª£c: " + score + " ƒëi·ªÉm";
        gameoverEl.style.display = "flex";
        playSound(150, 'sawtooth', 0.5);
    }

    drawCamera();
    drawMan(man.x, man.y);
    drawGirl(girl.x, girl.y);

    requestAnimationFrame(update);
}

function restart() {
    score = 0;
    scoreEl.textContent = 0;
    over = false;
    man.x = -60;
    man.speed = 2.5;
    splashes.length = 0; // X√≥a h·∫øt tia n∆∞·ªõc c≈©
    gameoverEl.style.display = "none";
    if (audioCtx.state === 'suspended') audioCtx.resume();
    update();
}

// Kh·ªüi ch·∫°y
update();
</script>
</body>
</html>
